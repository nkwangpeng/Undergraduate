
[TOC]

# ucoreOSæ“ä½œç³»ç»Ÿå®éªŒâ€”â€”Lab3

## é—®é¢˜å‘ç°&&æ”¹è¿›

åœ¨åˆå¹¶lab1/2/3æ—¶ï¼Œåœ¨pmm.cä¸­ï¼Œå¯¹boot_pgdirçš„èµ‹å€¼ä¸åŒï¼Œç†è®ºä¸Šè¿™å—å„¿æ˜¯æ²¡æœ‰ç»è¿‡æ”¹åŠ¨çš„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºä»£ç çš„ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å‡ºç°å·®åˆ«ã€‚
![](./1.jpg)

- çœ‹åˆ°äº†å¾ˆå¥½çš„æ‰“patchçš„æ–¹æ³•è§£å†³mergeçš„æ—¶å€™çš„å†²çªé—®é¢˜ï¼Œå­¦ä¹ ä¸€ä¸‹ï¼š

  ```bash
  diff -r -u -P lab2_origin lab2 > lab2.patch
  cd lab3
  patch -p1 -u < ../lab2.patch
  ```

  åŸºæœ¬ä¸Šå°±å¥½å•¦ï¼Œä½†æ˜¯lab3å°±æ˜¯è¿˜æœ‰é—®é¢˜ï¼Œç„¶åæˆ‘åˆæ‰‹åŠ¨è¡¥è¶³äº†ä¸€ä¸‹ã€‚ã€‚ã€‚

- æœ€ä¸€å¼€å§‹å¹¶æ²¡ç›´æ¥çœ‹æ‡‚help commentï¼Œå†åŠ ä¸Šæƒ³åšä¸€ä¸ªChallengeæ‰€ä»¥å°±ç»†è‡´å­¦ä¹ ä¸€ä¸‹å®éªŒä¹¦åé¢çš„é¡µé¢ç½®æ¢æœºåˆ¶ï¼ï¼é¡ºä¾¿å¤ä¹ ä¸€ä¸‹ä¸Šè¯¾å†…å®¹\_(:Ğ·ã€âˆ )_

---

- page faultåŸå› 

  - ç›®æ ‡é¡µå¸§ä¸å­˜åœ¨ï¼ˆé¡µè¡¨é¡¹å…¨ä¸º0ï¼Œå³è¯¥çº¿æ€§åœ°å€ä¸ç‰©ç†åœ°å€å°šæœªå»ºç«‹æ˜ å°„æˆ–è€…å·²ç»æ’¤é”€)ï¼›
  - ç›¸åº”çš„ç‰©ç†é¡µå¸§ä¸åœ¨å†…å­˜ä¸­ï¼ˆé¡µè¡¨é¡¹éç©ºï¼Œä½†Presentæ ‡å¿—ä½=0ï¼Œæ¯”å¦‚åœ¨swapåˆ†åŒºæˆ–ç£ç›˜æ–‡ä»¶ä¸Š)ï¼Œè¿™åœ¨æœ¬æ¬¡å®éªŒä¸­ä¼šå‡ºç°ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢ä»‹ç»æ¢é¡µæœºåˆ¶å®ç°æ—¶è¿›ä¸€æ­¥è®²è§£å¦‚ä½•å¤„ç†ï¼›
  - ä¸æ»¡è¶³è®¿é—®æƒé™(æ­¤æ—¶é¡µè¡¨é¡¹Pæ ‡å¿—=1ï¼Œä½†ä½æƒé™çš„ç¨‹åºè¯•å›¾è®¿é—®é«˜æƒé™çš„åœ°å€ç©ºé—´ï¼Œæˆ–è€…æœ‰ç¨‹åºè¯•å›¾å†™åªè¯»é¡µé¢).

- æ¢å‡ºé¡µçš„ç‰¹å¾ï¼šæ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ä¸”è¢«ç”¨æˆ·ç¨‹åºç›´æ¥è®¿é—®çš„é¡µé¢æ‰èƒ½è¢«äº¤æ¢ï¼Œå†…æ ¸ç›´æ¥ä½¿ç”¨çš„å†…æ ¸ç©ºé—´çš„é¡µé¢ä¸èƒ½è¢«æ¢å‡º(å®«è€å¸ˆä¸Šè¯¾è®²çš„ä¾‹å­å“ˆå“ˆå“ˆ)

- é¡µè¢«ç½®æ¢åˆ°ç¡¬ç›˜ä¸Šçš„8ä¸ªæ‰‡åŒº(0.5KB/æ‰‡åŒº)ï¼ŒPTE_På°±ç”¨æ¥è¡¨ç¤ºä¸ç‰©ç†é¡µçš„æ˜ å°„å…³ç³»ï¼Œä¸º0å°±åœ¨ç¡¬ç›˜

  > å®éªŒä¸‰å¯ä»¥ä¿å­˜262144/8=32768ä¸ªé¡µï¼Œå³128MBçš„å†…å­˜ç©ºé—´ã€‚swap åˆ†åŒºçš„å¤§å°æ˜¯ swapfs_init é‡Œé¢æ ¹æ®ç£ç›˜é©±åŠ¨çš„æ¥å£è®¡ç®—å‡ºæ¥çš„ï¼Œç›®å‰ ucore é‡Œé¢è¦æ±‚ swap ç£ç›˜è‡³å°‘åŒ…å« 1000 ä¸ª pageï¼Œå¹¶ä¸”è‡³å¤šèƒ½ä½¿ç”¨ 1<<24 ä¸ªpage

- Page faultæ—¶æ¢å…¥ï¼Œæ¢å‡ºåˆ™åˆ†ä¸ºç§¯æå’Œæ¶ˆæä¸¤ç§ç­–ç•¥ï¼Œç§¯æå°±æ˜¯å®šæ—¶æˆ–ç©ºé—²æ—¶å°±è¿›è¡Œä»¥ä¿è¯æ€»æ˜¯å¤Ÿç”¨çš„ï¼›æ¶ˆææ˜¯åªæœ‰åœ¨æ²¡æœ‰ç©ºé—²é¡µåˆ†é…æ—¶æ‰è¿›è¡Œæ¢å‡ºï¼Œlab3æ˜¾ç„¶æ˜¯æ¶ˆæçš„

---

- æ­¤å¤–ï¼Œè¿™æ¬¡ä»£ç é‡æ¯”å‰ä¸¤æ¬¡éƒ½å°‘å¥½å¤šï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯ï¼Œåœ¨å†™challengeçš„æ—¶å€™æˆ‘æœ¬æ¥åªæƒ³åœ¨fifoé‡Œé¢æ”¹å¹¶æŠŠfifo manageræ¢æˆæˆ‘å†™å¥½çš„enhanced_clockå°±è¡Œä½†æ˜¯æ€»æ˜¯æŠ¥ä¸€ä¸ªç©ºè¡Œçš„ç¥å¥‡çš„é”™ï¼Ÿï¼Ÿæ‰€ä»¥çœ‹ç½‘ä¸Šå¤§ä½¬éƒ½æ˜¯å¦å¤–å†™äº†ä¸€å¥—manageræ‰€ä»¥æˆ‘å°±è¿˜æ˜¯åƒä¸Šä¸€æ¬¡ä¼™ä¼´ç³»ç»Ÿä¸€æ ·åˆæ–°å†™äº†ä¸€ä¸ªmanagerç±»å°±ç¥å¥‡çš„å¥½äº†ï¼Ÿï¼Ÿï¼Ÿ

## ç»ƒä¹ 0

> ä»¥åæ¯æ¬¡éƒ½æ˜¯è¦åŸºäºå‰ä¸€æ¬¡labçš„å·¥ä½œæ‰èƒ½ç»§ç»­ï¼Œæ„Ÿè§‰æ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªç”±æµ…è‡³æ·±æ­å»ºä¸€ä¸ªOSçš„è¿‡ç¨‹

ç”±äºå‰ä¸€æ¬¡Meldè¿˜æœ‰Gitçš„mergeè®©äººå¾ˆè¿·ä¹±ï¼Œä»¥åŠå¹¶ä¸ä¼šç”¨patchï¼Œè¿™æ¬¡ä¹‹åå»å­¦ä¹ ä¸€ä¸‹ã€‚æ‰€ä»¥è¿™æ¬¡ä¾ç„¶æ˜¯é€‰æ‹©æ‰‹åŠ¨merge(è¿™ä¹ˆçœ‹ä¸‹æ¥å…¶å®å‰ä¸¤ä¸ªlabä¹Ÿå¹¶æ²¡æœ‰å†™å¤ªå¤šä»£ç ï¼Œä¸»è¦æ˜¯åŸºç¡€çŸ¥è¯†çš„è¡¥è¶³å¤ªå¤šäº†\_(:Ğ·ã€âˆ )_)

## ç»ƒä¹ ä¸€

>  **ç»™æœªè¢«æ˜ å°„çš„åœ°å€æ˜ å°„ä¸Šç‰©ç†é¡µï¼ˆéœ€è¦ç¼–ç¨‹ï¼‰**
>
> å®Œæˆdo_pgfaultï¼ˆmm/vmm.cï¼‰å‡½æ•°ï¼Œç»™æœªè¢«æ˜ å°„çš„åœ°å€æ˜ å°„ä¸Šç‰©ç†é¡µã€‚è®¾ç½®è®¿é—®æƒé™ çš„æ—¶å€™éœ€è¦å‚è€ƒé¡µé¢æ‰€åœ¨ VMA çš„æƒé™ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„æ˜ å°„ç‰©ç†é¡µæ—¶éœ€è¦æ“ä½œå†…å­˜æ§åˆ¶ ç»“æ„æ‰€æŒ‡å®šçš„é¡µè¡¨ï¼Œè€Œä¸æ˜¯å†…æ ¸çš„é¡µè¡¨ã€‚æ³¨æ„ï¼šåœ¨LAB3 EXERCISE 1å¤„å¡«å†™ä»£ç ã€‚

do_pgfault()æ˜¯ç”¨æ¥ä¸­æ–­ä»¥å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„å‡½æ•°ï¼Œæ¶‰åŠmmå’Œvmaä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒä»¬æ˜¯ç”¨æ¥æè¿°ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„â€œåˆæ³•â€è™šæ‹Ÿé¡µçš„æ•°æ®ç»“æ„ã€‚

ç”±äºè¿™äº›è™šæ‹Ÿé¡µå®é™…ä¸Šå¹¶æ²¡æœ‰è¢«åˆ†é…ï¼Œæ‰€ä»¥è®¿é—®è¿™äº›è™šæ‹Ÿé¡µçš„æ—¶å€™ä¼šå‡ºç°pagefaultå¼‚å¸¸ï¼Œè€Œdo_pgfault()çš„åŠŸèƒ½å°±æ˜¯åœ¨å¤„ç†å¼‚å¸¸çš„æ—¶å€™å®Œæˆå¯¹å…¶çš„ç‰©ç†é¡µåˆ†é…æ˜ å°„ï¼Œè€Œåœ¨ä¸­æ–­è¿”å›åå°±å¯ä»¥æ­£å¸¸å¯¹è¿™äº›è™šæ‹Ÿé¡µè¿›è¡Œè®¿é—® 

### ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„

```cpp
struct mm_struct { // æè¿°ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´
    list_entry_t mmap_list;        // é“¾æ¥åŒä¸€Directoryçš„è™šæ‹Ÿå†…å­˜ç©ºé—´çš„åŒå‘é“¾è¡¨å¤´èŠ‚ç‚¹ 
    struct vma_struct *mmap_cache; // å½“å‰æ­£åœ¨ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜ç©ºé—´
    pde_t *pgdir;                  // è¯¥æ•°æ®ç»“æ„æ‰€å¯¹åº”çš„é¡µè¡¨åœ°å€(ç”¨ä»¥æ‰¾PTE)
    int map_count;                 // è™šæ‹Ÿå†…å­˜å—çš„æ•°ç›®
    void *sm_priv;                 // è®°å½•è®¿é—®æƒ…å†µé“¾è¡¨å¤´åœ°å€(ç”¨äºç½®æ¢ç®—æ³•)
};
struct vma_struct { // è™šæ‹Ÿå†…å­˜ç©ºé—´
    struct mm_struct *vm_mm; // è™šæ‹Ÿå†…å­˜ç©ºé—´æ‰€å±çš„è¿›ç¨‹
    uintptr_t vm_start; // è¿ç»­åœ°å€çš„è™šæ‹Ÿå†…å­˜ç©ºé—´çš„èµ·å§‹ä½ç½®å’Œç»“æŸä½ç½®
    uintptr_t vm_end;
    uint32_t vm_flags; // è™šæ‹Ÿå†…å­˜ç©ºé—´çš„å±æ€§ (è¯»/å†™/æ‰§è¡Œ)
    list_entry_t list_link; // åŒå‘é“¾è¡¨    ä»å°åˆ°å¤§å°†è™šæ‹Ÿå†…å­˜ç©ºé—´é“¾æ¥èµ·æ¥
};
```

### page faultå¤„ç†æµç¨‹

> å‚ç…§do_pgfault()æ³¨é‡Šç»™å‡ºçš„CALL GRAPHï¼štrap--> trap_dispatch-->pgfault_handler-->do_pgfault

- å‰ä¸¤æ­¥å’Œå…¶å®ƒä¸­æ–­çš„å¤„ç†ä¸€è‡´ï¼Œç¡¬ä»¶å°†ç¨‹åºçŠ¶æ€å­—å‹å…¥ä¸­æ–­æ ˆï¼Œä¸ucoreä¸­çš„éƒ¨åˆ†ä¸­æ–­å¤„ç†ä»£ç ä¸€èµ·å»ºç«‹ä¸€ä¸ªtrapframeï¼ŒåŒæ—¶ç¡¬ä»¶è¿˜ä¼šå°†å‡ºç°äº†å¼‚å¸¸çš„çº¿æ€§åœ°å€ä¿å­˜åœ¨cr2å¯„å­˜å™¨ä¸­(lab1&2æ¶‰åŠäº†è®¸å¤š)
- ä¹‹åæ¥åˆ°trap_dispatch()ï¼Œæ ¹æ®å…¶å¯¹åº”ä¸­æ–­å·ï¼Œå°†å®ƒäº¤ç»™pgfault_handler()(trap.cä¸­æ£€æŸ¥mmç»“æ„ä¸ä¸ºç©ºä»¥åäº¤ç»™do_pgfault())å¤„ç†ï¼Œpgfault_handler()å†äº¤ç»™do_pgfault()ï¼Œå³æˆ‘ä»¬è¦ç¼–ç¨‹çš„éƒ¨åˆ†

### å®ç°

do_pgfault()çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªä¿å­˜åœ¨cr2å¯„å­˜å™¨ï¼ˆé¡µæ•…éšœçº¿æ€§åœ°å€å¯„å­˜å™¨)ä¸­çš„çº¿æ€§åœ°å€ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†page faultçš„çº¿æ€§åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è®°åœ¨trapframeé‡Œé¢çš„ç¡¬ä»¶äº§ç”Ÿçš„error codeï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯pgfault_handler()ä¼ è¿‡æ¥çš„mmæ•°æ®ç»“æ„ï¼Œå®ƒå°†PDTä¿å­˜åœ¨é“¾è¡¨ä¸­(æ•°æ®ç»“æ„å®šä¹‰è§vmm.h)

1. é¦–å…ˆæŸ¥è¯¢mm_structä¸­çš„åˆæ³•çš„è™šæ‹Ÿåœ°å€é“¾è¡¨(vma)ï¼Œç”¨äºç¡®å®šå½“å‰å‡ºç°page faultçš„çº¿æ€§åœ°å€æ˜¯å¦åˆæ³•ï¼Œåˆæ³•åˆ™ç»§ç»­ï¼Œåä¹‹ç›´æ¥è¿”å›ï¼›
```cpp
int
do_pgfault(struct mm_struct *mm, uint32_t error_code, uintptr_t addr) {
    int ret = -E_INVAL;
    //try to find a vma which include addr
    struct vma_struct *vma = find_vma(mm, addr);
    //æ‰¾åˆ°å¯¹åº”åœ°å€å’Œmmçš„vma
    pgfault_num++;
    //If the addr is in the range of a mm's vma?
    if (vma == NULL || vma->vm_start > addr) {//ä¸åˆæ³•åœ°å€æˆ–ä¸åœ¨èŒƒå›´å†…
        cprintf("not valid addr %x, and  can not find it in vma\n", addr);
        goto failed;
    }
```

2. æ£€æŸ¥error code(switch(error_code&3))ï¼šå› ä¸ºæŒ‰ç…§æ³¨é‡Šä¸­çš„å†…å®¹æˆ‘ä»¬å…¶å®åªéœ€è¦æ£€æŸ¥0-1ä½ï¼Œæ‰€ä»¥æ˜¯&3ï¼Œå¯å†™ä¸”å­˜åœ¨çš„é¡µå°±æ˜¯3ï¼Œå¦‚æœæ˜¯å…¶ä»–ä¸æ»¡è¶³æˆ‘ä»¬è¦æ˜ å°„ç‰©ç†é¡µçš„è¦æ±‚çš„æ—¶å€™å°±æ‰“å°é”™è¯¯å¹¶ç›´æ¥è¿”å›

```cpp
  switch (error_code & 3) {
  default://é»˜è®¤3å³åˆç†çš„
          /* error code flag : default is 3 ( W/R=1, P=1): write, present */
          //ä»¥ä¸‹æ˜¯å„ç§å½¢å¼çš„æŠ¥é”™
  case 2: /* error code flag : (W/R=1, P=0): write, not present */
      if (!(vma->vm_flags & VM_WRITE)) {
          cprintf("do_pgfault failed: error code flag = write AND not present, but the addr's vma cannot write\n");
          goto failed;
      }
      break;
  case 1: /* error code flag : (W/R=0, P=1): read, present */
      cprintf("do_pgfault failed: error code flag = read AND present\n");
      goto failed;
  case 0: /* error code flag : (W/R=0, P=0): read, not present */
      if (!(vma->vm_flags & (VM_READ | VM_EXEC))) {
          cprintf("do_pgfault failed: error code flag = read AND not present, but the addr's vma cannot read or exec\n");
          goto failed;
      }
  }
```

3. æ¥ä¸‹æ¥æ ¹æ®åˆæ³•è™šæ‹Ÿåœ°å€ï¼ˆmm_structä¸­ä¿å­˜çš„åˆæ³•è™šæ‹Ÿåœ°å€é“¾è¡¨ä¸­å¯æŸ¥è¯¢åˆ°ï¼‰çš„æ ‡å¿—ï¼Œæ¥ç”Ÿæˆå¯¹åº”äº§ç”Ÿçš„ç‰©ç†é¡µçš„æƒé™
```cpp
  uint32_t perm = PTE_U;
  if (vma->vm_flags & VM_WRITE) {  //VM_WRITE   0x00000002
      perm |= PTE_W;    //å¯å†™çš„
  }
  addr = ROUNDDOWN(addr, PGSIZE);
  //æŠŠåŸæ¥çš„addræŒ‰PSIZE=4096çš„å€æ•°å‘ä¸‹èˆå»
  ret = -E_NO_MEM;//E_NO_MEM 4 å› ä¸ºå†…å­˜ä¸è¶³è¯·æ±‚å¤±è´¥

  pte_t *ptep=NULL;
```

4. ä¹‹åå°±æ˜¯è¦ä»£ç å®ç°çš„éƒ¨åˆ†(ä¾ç„¶æ˜¯å€ŸåŠ©å’ŒæŒ‰ç…§help commentçš„å®ç°)

   ç›¸å…³å®å®šä¹‰åŠå‡½æ•°ï¼š

   ```c
   get_pte //pmm.c lab2å®Œæˆçš„æ ¹æ®è™šæ‹Ÿçº¿æ€§åœ°å€è¿”å›pteçš„å‡½æ•°,å¦‚æœä¸å­˜åœ¨å°±åˆ†é…ä¸€ä¸ª
   pgdir_alloc_page //åˆ†é…ä¸€ä¸ªç‰©ç†é¡µå¹¶å°†å®ƒä¸å…¶å¯¹åº”çš„è™šæ‹Ÿåœ°å€å»ºç«‹æ˜ å°„å…³ç³»
   VM_WRITE  //vmm.h   =0x00000002 å³vm_flagsç¬¬1ä½,1å¯å†™0åªè¯»
   PTE_W   PTE_U//åŒlab2åˆ†åˆ«è¡¨ç¤ºä¸€çº§/äºŒçº§é¡µè¡¨æ˜¯å¦å¯å†™ ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒ
   mm->pgdir    //vmm.h   vmaçš„å¯¹åº”PDT
   ```

   ç»ƒä¹ ä¸€çš„å®ç°å¾ˆç®€å•ï¼š

   1. è·å–å‘ç”Ÿç¼ºé¡µçš„è™šæ‹Ÿåœ°å€
   2. å¦‚æœéœ€è¦çš„ç‰©ç†é¡µæ˜¯æ²¡æœ‰è¢«åˆ†é…çš„åˆ†é…ç‰©ç†é¡µå¹¶å°†å…¶ä¸è™šæ‹Ÿé¡µå»ºç«‹æ˜ å°„å…³ç³»,perm æ˜¯â¼€ä¸ªPTEå¯å†™æ ‡å¿—ä½
```cpp
  ptep = get_pte(mm->pgdir, addr, 1); 
  if (*ptep == 0) { 
      // å¦‚æœéœ€è¦çš„ç‰©ç†é¡µæ˜¯æ²¡æœ‰åˆ†é…(æ²¡æœ‰æ˜ å°„)ä¸”æ²¡æœ‰è¢«æ¢å‡ºåˆ°å¤–å­˜ä¸­
      //addrå°±æ˜¯å‰é¢çš„ç»è¿‡rounddownçš„è™šæ‹Ÿé¡µåœ°å€
      //perm æ˜¯å‰é¢PTE_W   PTE_Uå¤„ç†åæœ‰æƒé™çš„flag
      struct Page* page = pgdir_alloc_page(mm->pgdir, addr, perm); 
      // åˆ†é…ç‰©ç†é¡µï¼Œå¹¶ä¸”ä¸å¯¹åº”çš„è™šæ‹Ÿé¡µå»ºç«‹æ˜ å°„å…³ç³»
  }  
```

### å›ç­”é—®é¢˜

> 1. è¯·æè¿°é¡µç›®å½•é¡¹ï¼ˆPage Directory Entryï¼‰å’Œé¡µè¡¨é¡¹ï¼ˆPage Table Entryï¼‰ä¸­ç»„æˆéƒ¨åˆ†å¯¹ucoreå®ç°é¡µæ›¿æ¢ç®—æ³•çš„æ½œåœ¨ç”¨å¤„ã€‚
> 2. å¦‚æœucoreçš„ç¼ºé¡µæœåŠ¡ä¾‹ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è®¿é—®å†…å­˜ï¼Œå‡ºç°äº†é¡µè®¿é—®å¼‚å¸¸ï¼Œè¯·é—®ç¡¬ä»¶è¦åšå“ªäº›äº‹æƒ…ï¼Ÿ

- PDEå’ŒPTEä¸­çš„ä½ä½éƒ½æœ‰è®¸å¤šä¿ç•™ä½ä»¥ä¾›æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼ŒOSå¯ä»¥åˆ©ç”¨è¿™äº›ä½æ¥å®Œæˆä¸€äº›å…¶ä»–çš„å†…å­˜ç®¡ç†ç›¸å…³çš„ç®—æ³•ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œä¿å­˜æœ€è¿‘ä¸€æ®µæ—¶é—´å†…è¯¥é¡µè¢«è®¿é—®çš„æ¬¡æ•°ï¼Œå¯ä»¥å€ŸåŠ©ä½åˆ¤æ–­å®ç°Enhanced Clockç®—æ³•ã€‚è¿™äº›ä¿ç•™ä½æœ‰åˆ©äºOSè¿›è¡ŒåŠŸèƒ½çš„æ‹“å±•
- Page Faultçš„ç¼ºé¡µå¼‚å¸¸åº”ä¸æ­£å¸¸å‡ºç°é¡µè®¿é—®å¼‚å¸¸çš„å¤„ç†ç›¸ä¸€è‡´
  - å°†å‘ç”Ÿé”™è¯¯çš„çº¿æ€§åœ°å€ä¿å­˜åœ¨cr2å¯„å­˜å™¨ä¸­;
  - åœ¨ä¸­æ–­æ ˆä¸­ä¾æ¬¡å‹å…¥EFLAGSï¼ŒCS, EIPï¼Œä»¥åŠé¡µè®¿é—®å¼‚å¸¸ç error codeï¼Œç”±äºISRä¸€å®šæ˜¯è¿è¡Œåœ¨å†…æ ¸æ€ä¸‹çš„ï¼Œå› æ­¤ä¸éœ€è¦å‹å…¥sså’Œespä»¥åŠè¿›è¡Œæ ˆçš„åˆ‡æ¢ï¼›
  - æ ¹æ®ä¸­æ–­æè¿°ç¬¦è¡¨æŸ¥è¯¢åˆ°å¯¹åº”é¡µè®¿é—®å¼‚å¸¸çš„ISRï¼Œè·³è½¬åˆ°å¯¹åº”çš„ISRå¤„æ‰§è¡Œï¼Œæ¥ä¸‹æ¥å°†ç”±è½¯ä»¶è¿›è¡Œå¤„ç†ï¼›

## ç»ƒä¹ äºŒ

> å®Œæˆvmm.cä¸­çš„do_pgfaultå‡½æ•°ï¼Œå¹¶ä¸”åœ¨å®ç°FIFOç®—æ³•çš„swap_fifo.cä¸­å®Œæˆmap_swappableå’Œswap_out_victimå‡½æ•°ã€‚é€šè¿‡å¯¹swapçš„æµ‹è¯•ã€‚æ³¨æ„ï¼šåœ¨LAB3 EXERCISE 2å¤„å¡«å†™ä»£ç 

### do_pgfault()æ­¥éª¤

- å·²çŸ¥è¯¥ç‰©ç†é¡µè¢«æ¢åˆ°å¤–å­˜ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯¹äº¤æ¢æœºåˆ¶è¿›è¡Œäº†æ­£ç¡®çš„åˆå§‹åŒ–
- æ ¹æ®mmå’Œaddræä¾›çš„ä¿¡æ¯å°†è™šæ‹Ÿé¡µå¯¹åº”çš„ç‰©ç†é¡µä»å¤–å­˜æ¢å…¥å†…å­˜
- ç»™æ¢å…¥çš„ç‰©ç†é¡µä¸è™šæ‹Ÿé¡µå»ºç«‹æ˜ å°„å…³ç³»
- å°†ç‰©ç†é¡µè®¾ç½®ä¸ºå¯è¢«æ¢å‡º

ç›¸å…³å®åŠå‡½æ•°

```c
swap_in(mm, addr, &page) //swap.c å°†ç‰©ç†é¡µæ¢å…¥å†…å­˜
page_insert   //pmm.c  å»ºç«‹ç‰©ç†é¡µä¸è™šæ‹Ÿé¡µä¹‹é—´çš„æ˜ å°„å…³ç³»
swap_map_swappable //swap.c å°†ç‰©ç†é¡µè®¾ä¸ºå¯äº¤æ¢çš„
```

### FIFOæµç¨‹

é€šè¿‡åˆ†æğŸ‘†çš„do_pgfault()å‘ç°æˆ‘ä»¬é¦–å…ˆè¦å®ç°swap_fifo.cé‡Œé¢çš„FIFOç½®æ¢ç®—æ³•

- ä¸ºäº†ç®¡ç†æ‰€æœ‰å¯äº¤æ¢çš„ç‰©ç†é¡µï¼Œç”¨ä¸€ä¸ªé“¾è¡¨pra_list_headæ¥è®°å½•å®ƒä»¬
- æŠŠmmçš„sm_privæŒ‡å‘pra_list_headçš„åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡mmè®¿é—®
- æŠŠæœ€è¿‘åˆ°è¾¾çš„ç‰©ç†é¡µé“¾æ¥pra_list_headçš„æœ€å(ç¼–ç¨‹)
- å‡½æ•°åå–å¾—å¾ˆå½¢è±¡hhæ‰¾å‡ºè¦è¢«æ¢å‡ºå»çš„å—å®³è€…é¡µ(ç¼–ç¨‹)

### å®ç°

#### do_pgfault()éƒ¨åˆ†ï¼š

```CPP
  else {
      if (swap_init_ok) { // åˆ¤æ–­äº¤æ¢æœºåˆ¶æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–swapinitåä¼šå°†è¯¥å˜é‡ç½®1
          struct Page *page = NULL;
          swap_in(mm, addr, &page); //å°†ç‰©ç†é¡µæ¢å…¥åˆ°å†…å­˜ä¸­
          page_insert(mm->pgdir, page, addr, perm); //å°†ç‰©ç†é¡µä¸è™šæ‹Ÿé¡µå»ºç«‹æ˜ å°„å…³ç³»
          swap_map_swappable(mm, addr, page, 1); // è®¾ç½®å½“å‰çš„ç‰©ç†é¡µä¸ºå¯äº¤æ¢çš„
          page->pra_vaddr = addr; 
          // åŒæ—¶åœ¨ç‰©ç†é¡µä¸­ç»´æŠ¤å…¶å¯¹åº”åˆ°çš„è™šæ‹Ÿé¡µçš„ä¿¡æ¯
          // pra_vaddrç”¨æ¥è®°å½•æ­¤ç‰©ç†é¡µå¯¹åº”çš„è™šæ‹Ÿé¡µèµ·å§‹åœ°å€        
      } 
      else {
          cprintf("no swap_init_ok but ptep is %x, failed\n",*ptep);
          goto failed;
      }
  }
```

####  FIFO

##### _fifo_map_swappableï¼š

å› ä¸ºFIFOåŸºäºåŒå‘é“¾è¡¨å®ç°ï¼Œæ‰€ä»¥åŠ åˆ°é“¾è¡¨çš„æœ€åå…¶å®åªç”¨list_add_beforeå°†å®ƒåŠ åˆ°headçš„å‰é¢å°±å¯ä»¥äº†

```cpp
static int
_fifo_map_swappable(struct mm_struct *mm, uintptr_t addr, struct Page *page, int swap_in)
{
    list_entry_t *head=(list_entry_t*) mm->sm_priv;// æ‰¾åˆ°é“¾è¡¨å…¥å£
    list_entry_t *entry=&(page->pra_page_link);//æ‰¾åˆ°å½“å‰ç‰©ç†é¡µç”¨äºç»„ç»‡æˆé“¾è¡¨çš„list_entry_t
    assert(entry != NULL && head != NULL);
    //record the page access situlation
    /*LAB3 EXERCISE 2: YOUR CODE*/ 
    //(1)link the most recent arrival page at the back of the pra_list_head qeueue.
    list_add_before(head,entry); // å°†å½“å‰æŒ‡å®šçš„ç‰©ç†é¡µæ’å…¥åˆ°é“¾è¡¨çš„æœ«å°¾
    return 0;
}
```

##### _fifo_swap_out_victim

æ ¹æ®FIFOæ€æƒ³ï¼Œæ‰¾å‡ºæœ€å…ˆè®¿é—®å³ç¬¬ä¸€ä¸ªè¿›å…¥é“¾è¡¨çš„ä¹Ÿå°±æ˜¯å¤´ç»“ç‚¹å¹¶åˆ æ‰å°±å¥½äº†

```cpp
static int
_fifo_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, int in_tick)
{
     list_entry_t *head=(list_entry_t*) mm->sm_priv;// æ‰¾åˆ°é“¾è¡¨çš„å…¥å£
     assert(head != NULL);
     assert(in_tick==0);
     /* Select the victim */
     /*LAB3 EXERCISE 2: YOUR CODE*/ 
     //(1)  unlink the  earliest arrival page in front of pra_list_head qeueue
     //(2)  set the addr of addr of this page to ptr_page
     list_entry_t *le = list_next(head); // å–å‡ºé“¾è¡¨å¤´ï¼Œå³æœ€å…ˆè¿›å…¥çš„ç‰©ç†é¡µ
     assert(le != head); // ç¡®ä¿ä¸æ˜¯head
     //pra_page_linkæ˜¯Pageç»“æ„ä¸­ç”¨æ¥æ„é€ æŒ‰ç¬¬ä¸€æ¬¡è®¿é—®æ—¶é—´æ’åºçš„é“¾è¡¨
     struct Page *page = le2page(le, pra_page_link);//æ‰¾åˆ°å…¶å¯¹åº”çš„ç‰©ç†é¡µçš„Pageç»“æ„
     list_del(le); // ä»é“¾è¡¨ä¸Šåˆ é™¤å°†è¢«æ¢å‡ºçš„ç‰©ç†é¡µ
     *ptr_page = page;
     return 0;
}
```

### å›ç­”é—®é¢˜

> å¦‚æœè¦åœ¨ucoreä¸Šå®ç°"extended clocké¡µæ›¿æ¢ç®—æ³•"è¯·ç»™ä½ çš„è®¾è®¡æ–¹æ¡ˆï¼Œç°æœ‰çš„swap_manageræ¡†æ¶æ˜¯å¦è¶³ä»¥æ”¯æŒåœ¨ucoreä¸­å®ç°æ­¤ç®—æ³•ï¼Ÿå¦‚æœæ˜¯ï¼Œè¯·ç»™ä½ çš„è®¾è®¡æ–¹æ¡ˆã€‚å¦‚æœä¸æ˜¯ï¼Œè¯·ç»™å‡ºä½ çš„æ–°çš„æ‰©å±•å’ŒåŸºæ­¤æ‰©å±•çš„è®¾è®¡æ–¹æ¡ˆã€‚å¹¶éœ€è¦å›ç­”å¦‚ä¸‹é—®é¢˜ï¼š
>
> 1. éœ€è¦è¢«æ¢å‡ºçš„é¡µçš„ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ
> 2. åœ¨ucoreä¸­å¦‚ä½•åˆ¤æ–­å…·æœ‰è¿™æ ·ç‰¹å¾çš„é¡µï¼Ÿ
> 3. ä½•æ—¶è¿›è¡Œæ¢å…¥å’Œæ¢å‡ºæ“ä½œï¼Ÿ

- é—®é¢˜

  - è¢«æ¢å‡ºçš„é¡µç‰¹å¾
    - è¯¥ç‰©ç†é¡µåœ¨å½“å‰æŒ‡é’ˆä¸Šä¸€æ¬¡æ‰«è¿‡ä¹‹å‰æ²¡æœ‰è¢«è®¿é—®ï¼›
    - è¯¥ç‰©ç†é¡µçš„å†…å®¹ä¸å…¶åœ¨å¤–å­˜ä¸­ä¿å­˜çš„æ•°æ®æ˜¯ä¸€è‡´çš„, å³æ²¡æœ‰è¢«ä¿®æ”¹è¿‡çš„;
  - å¦‚ä½•åˆ¤æ–­
    - å½“å†…å­˜é¡µè¢«è®¿é—®åï¼ŒMMUå°†åœ¨å¯¹åº”çš„é¡µè¡¨é¡¹çš„`PTE_A`ç½®1(Access)
    - å½“å†…å­˜é¡µè¢«ä¿®æ”¹åï¼ŒMMUå°†åœ¨å¯¹åº”çš„é¡µè¡¨é¡¹çš„`PTE_D`ç½®1(Dirty)
  - ä½•æ—¶æ“ä½œ
    - åœ¨äº§ç”Ÿç¼ºé¡µç°è±¡page faultä¸­æ–­çš„æ—¶å€™è¿›è¡Œæ¢å…¥æ“ä½œ
    - å½“ä½äºç‰©ç†é¡µæ¡†ä¸­çš„å†…å­˜è¢«é¡µé¢æ›¿æ¢ç®—æ³•æ‰€é€‰æ‹©æ—¶ï¼Œéœ€è¦è¿›è¡Œæ¢å‡ºæ“ä½œ

- å¯ä»¥å®ç°

  æ ¹æ®ä¸Šè¿°å›ç­”ï¼Œåªéœ€è¦é‡å†™swap_out_victim

  - ä»å½“å‰æŒ‡é’ˆå¼€å§‹ï¼Œå¯¹åŒå‘é“¾è¡¨è¿›è¡Œæ‰«æï¼Œæ ¹æ®æŒ‡é’ˆæŒ‡å‘çš„ç‰©ç†é¡µçš„çŠ¶æ€ï¼ˆ(access, dirty)ï¼‰æ¥ç¡®å®šåº”å½“è¿›è¡Œä½•ç§ä¿®æ”¹
    - çŠ¶æ€ä¸º(0, 0)ï¼Œåˆ™å°†è¯¥ç‰©ç†é¡µé¢ä»é“¾è¡¨åˆ é™¤ï¼Œè¯¥ç‰©ç†é¡µè®°ä¸ºæ¢å‡ºé¡µï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªæ—¶å€™è¿™ä¸€é¡µä¸æ˜¯dirtyçš„ï¼Œå› æ­¤ä¸éœ€è¦å°†å…¶å†™å…¥swapåˆ†åŒº
    - çŠ¶æ€ä¸º(0, 1)ï¼Œåˆ™å°†è¯¥ç‰©ç†é¡µå¯¹åº”çš„è™šæ‹Ÿé¡µçš„PTEä¸­çš„dirtyä½éƒ½æ”¹æˆ0ï¼Œå¹¶å°†è¯¥ç‰©ç†é¡µå†™å…¥å¤–å­˜ä¸­ï¼Œç„¶åæŒ‡é’ˆè·³è½¬åˆ°ä¸‹ä¸€ä¸ªç‰©ç†é¡µ
    - å¦‚æœçŠ¶æ€æ˜¯(1, 0), å°†è¯¥ç‰©ç†é¡µå¯¹åº”çš„è™šæ‹Ÿé¡µçš„PTEä¸­çš„è®¿é—®ä½éƒ½ç½®æˆ0ï¼Œç„¶åæŒ‡é’ˆè·³è½¬åˆ°ä¸‹ä¸€ä¸ªç‰©ç†é¡µé¢
    - å¦‚æœçŠ¶æ€æ˜¯(1, 1)ï¼Œåˆ™è¯¥ç‰©ç†é¡µçš„æ‰€æœ‰å¯¹åº”è™šæ‹Ÿé¡µçš„PTEä¸­çš„è®¿é—®ä¸ºç½®æˆ0ï¼Œç„¶åæŒ‡é’ˆè·³è½¬åˆ°ä¸‹ä¸€ä¸ªç‰©ç†é¡µé¢


## Challenge1

> ###### å®ç°è¯†åˆ«dirty bitçš„ extended clocké¡µæ›¿æ¢ç®—æ³•

æ ¹æ®MOOCæ€»ç»“ä¸‹æ¥å°±æ˜¯

- æŒ‰ç…§ä¸Šé¢å›ç­”é—®é¢˜çš„è®°å½•(access, dirty)çŠ¶æ€çš„åŠæ³•åªéœ€è¦æœ€å¤šå¾ªç¯ä¸‰æ¬¡å°±å¯ä»¥æ‰¾åˆ°æ›´ä¸ºåˆé€‚çš„æ›¿æ¢é¡µ
- å¦‚æœè®¿é—®è¯¥é¡µï¼Œå°±å°†æ ‡è®°æ”¹ä¸º(1,0)ï¼›å†™è¯¥é¡µæ”¹æˆ(1,1)ï¼›
- æ­¤æ—¶éœ€è¦æ›¿æ¢é¡µæ—¶ï¼Œæœ‰(0,0)çŠ¶æ€ç›´æ¥æ›¿æ¢ï¼›å¦‚æœæ²¡æœ‰å°†(1,1)æ”¹ä¸º(1,0)ï¼Œ(1,0)æ”¹ä¸º(0,0)ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢

### å®ç°

è¿˜æ˜¯åŒlab2ä¸€æ ·ä»¿å†™ï¼Œç…§ç€swap_fifoå†å†™ä¸€ä¸ªswap_clockå³å¯

```cpp
static int
_extended_clock_swap_out_victim(struct mm_struct *mm, struct Page ** ptr_page, int in_tick)
{
    list_entry_t *head = (list_entry_t*)mm->sm_priv;
    assert(head != NULL);
    assert(in_tick == 0);
    list_entry_t *le = head->prev;
    assert(head != le);

    int i; // å¾ªç¯ä¸‰æ¬¡ å¯»æ‰¾åˆé€‚çš„ç½®æ¢é¡µ
    for (i = 0; i < 3; i++) {
        /* ç¬¬ä¸€æ¬¡å¾ªç¯ å¯»æ‰¾ æ²¡è¢«è®¿é—®è¿‡çš„ ä¸” æ²¡è¢«ä¿®æ”¹è¿‡çš„ åŒæ—¶å°†è¢«è®¿é—®è¿‡çš„é¡µçš„ è®¿é—®ä½ æ¸… 0
            ç¬¬äºŒæ¬¡å¾ªç¯ ä¾ç„¶æ˜¯å¯»æ‰¾ æ²¡è¢«è®¿é—®è¿‡çš„ ä¸” æ²¡è¢«ä¿®æ”¹è¿‡çš„ å› ä¸ºåˆ°äº†æ­¤æ¬¡å¾ªç¯ è®¿é—®ä½éƒ½è¢«æ¸… 0 äº† ä¸å­˜åœ¨è¢«è®¿é—®è¿‡çš„
            åªéœ€è¦æ‰¾æ²¡è¢«ä¿®æ”¹è¿‡çš„å³å¯ åŒæ—¶å°†è¢«ä¿®æ”¹è¿‡çš„é¡µ ä¿®æ”¹ä½ æ¸… 0
            ç¬¬ä¸‰æ¬¡å¾ªç¯ è¿˜æ˜¯æ‰¾ æ²¡è¢«è®¿é—®è¿‡ ä¸” æ²¡è¢«ä¿®æ”¹è¿‡çš„ æ­¤æ—¶ ç¬¬ä¸€æ¬¡å¾ªç¯ å·²ç»å°†æ‰€æœ‰è®¿é—®ä½ æ¸… 0 äº†
             ç¬¬äºŒæ¬¡å¾ªç¯ ä¹Ÿå·²ç»å°†æ‰€æœ‰ä¿®æ”¹ä½æ¸… 0 äº† æ•… åœ¨ç¬¬ä¸‰æ¬¡å¾ªç¯ ä¸€å®šæœ‰ æ²¡è¢«è®¿é—®è¿‡ ä¹Ÿæ²¡è¢«ä¿®æ”¹è¿‡çš„ é¡µ
        */
        while (le != head) {
            struct Page *page = le2page(le, pra_page_link);            
            pte_t *ptep = get_pte(mm->pgdir, page->pra_vaddr, 0);

            if (!(*ptep & PTE_A) && !(*ptep & PTE_D)) { // æ²¡è¢«è®¿é—®è¿‡ ä¹Ÿæ²¡è¢«ä¿®æ”¹è¿‡ 
                list_del(le);
                *ptr_page = page;
                return 0;
            }
            if (i == 0) {
                *ptep &= 0xFFFFFFDF;
            } else if (i == 1) {
                *ptep &= 0xFFFFFFBF;
            }
            le = le->prev;
        }
        le = le->prev;
    }
}
```

å¹¶åœ¨é¡µé¢ç½®æ¢ç®—æ³•ä¸­ä½¿ç”¨å®ƒ
```cpp
int
swap_init(void)
{
     swapfs_init();

     if (!(1024 <= max_swap_offset && max_swap_offset < MAX_SWAP_OFFSET_LIMIT))
     {
          panic("bad max_swap_offset %08x.\n", max_swap_offset);
     }
     

     sm = &swap_manager_clock;   //æ¢æˆclock
     int r = sm->init();
     
     if (r == 0)
     {
          swap_init_ok = 1;
          cprintf("SWAP: manager = %s\n", sm->name);
          check_swap();
     }

     return r;
}
```